<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¥ì†Œì“°ê¸°</title>
    <link rel="stylesheet" href="/default.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ì¹´ì¹´ì˜¤ë§µ API -->
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=278940b595d1bf12680c71409de85eda&libraries=services"></script>
<style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* ìŠ¤í¬ë¡¤ ì œê±° */
}
/* ì»¨í…Œì´ë„ˆë¥¼ í™”ë©´ ìƒë‹¨ì— ë”± ë¶™ì„ */
.container {
    margin: 0;
    padding: 0;
    width: 100%;
}
.modal-content {
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}
.form-control {
    border-radius: 5px;
}
.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}
.btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
}
.category-icons span {
    margin-right: 8px;
    font-size: 18px;
}
.modal-header {
	margin-bottom : 15px;
}
#placeList li {
    padding: 8px 12px;
    border-bottom: 1px solid #ddd; /* í•­ëª© êµ¬ë¶„ì„  */
    font-size: 14px;
    cursor: pointer;
}
</style>
</head>

<body>
<div class="container mt-5">
	<div class="modal-dialog">
		<th:block th:utext="${successScript}"></th:block>
		<div class="modal-content p-4">
			<div class="modal-header">
				<h3 class="modal-title">ì¥ì†Œ ì¶”ì²œê¸€ ì‘ì„±</h3>
				<button type="button" class="btn-close" onclick="window.close()"></button>
			</div>
			<div class="modal-body">
				<form id="locationForm" action="/location/locationwrite" method="post" th:object="${locationWrite}" onsubmit="return validateForm()">
					<!-- ì¥ì†Œëª… -->
					<div class="mb-3">
                        <label for="locationName" class="form-label">ì¥ì†Œ</label>
                        <input type="text" class="form-control" id="locationName" name="locationName" placeholder="ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" onkeyup="searchPlaces()" oninput="clearAddress()">
                        <ul id="placeList" class="list-group mt-2" style="max-height: 150px; overflow-y: auto;"></ul>
                    </div>
                    <!-- ì£¼ì†Œ -->
                    <div class="mb-3">
                        <label for="locationAddress" class="form-label">ì£¼ì†Œ</label>
                        <input type="text" class="form-control" id="locationAddress" name="locationAddress" placeholder="ì¥ì†Œëª…ì— ë”°ë¼ ì£¼ì†ŒëŠ” ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤" readonly>
                    </div>
                    <!-- ìˆ¨ê²¨ì§„ ì¢Œí‘œê°’ -->
                    <input type="hidden" id="locationLatitude" name="locationLatitude">
                    <input type="hidden" id="locationLongitude" name="locationLongitude">
                    <!-- ì¹´í…Œê³ ë¦¬ -->
                    <div class="mb-3">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <div class="category-icons">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="hospital" value="HOSPITAL">
                                <label class="form-check-label" for="hospital">
                                    ğŸ¥ ë³‘ì›
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="park" value="PARK">
                                <label class="form-check-label" for="park">
                                    ğŸï¸ ê³µì›
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="cafe" value="CAFE">
                                <label class="form-check-label" for="cafe">
                                    â˜• ì¹´í˜
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="kindergarten" value="KINDERGARTEN">
                                <label class="form-check-label" for="kindergarten">
                                    ğŸ  ìœ ì¹˜ì›
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="petshop" value="PETSHOP">
                                <label class="form-check-label" for="petshop">
                                    ğŸ›’ ì• ê²¬ìƒµ
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="locationCategory" id="others" value="OTHERS">
                                <label class="form-check-label" for="others">
                                    ğŸ·ï¸ ê¸°íƒ€
                                </label>
                            </div>
                        </div>
                     </div>
                    <!-- ë²„íŠ¼ -->
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary me-2">ë“±ë¡í•˜ê¸°</button>
                        <button type="button" class="btn btn-secondary" onclick="window.close()">ë‹«ê¸°</button>
                    </div>
				</form>
			</div>	
		</div>
	</div>
</div>

<!-- JavaScript í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ -->
<script>
let ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´
let geocoder = new kakao.maps.services.Geocoder(); // ì£¼ì†Œ ë³€í™˜ ê°ì²´

function searchPlaces() {
  let keyword = document.getElementById('locationName').value;

  if (!keyword) {
    return; // ì…ë ¥ê°’ ì—†ìœ¼ë©´ ì¤‘ë‹¨
  }

  ps.keywordSearch(keyword, function(data, status) {
    let placeList = document.getElementById('placeList');
    placeList.innerHTML = ""; // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”

    if (status === kakao.maps.services.Status.OK) {
      // ê²€ìƒ‰ ê²°ê³¼ ì¶”ê°€
      data.forEach(function(place) {
        let listItem = document.createElement('li');
        listItem.innerText = place.place_name; // ì¥ì†Œëª… í‘œì‹œ

        listItem.onclick = function() {
          // ì„ íƒí•œ ì¥ì†Œ ì •ë³´ë¥¼ ì…ë ¥
          document.getElementById('locationName').value = place.place_name;
          document.getElementById('locationAddress').value = place.address_name || place.road_address_name;

          // ì¢Œí‘œ ë³€í™˜ ë° ì €ì¥
          geocoder.addressSearch(place.address_name || place.road_address_name, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              document.getElementById('locationLatitude').value = result[0].y;
              document.getElementById('locationLongitude').value = result[0].x;
            }
          });

          placeList.innerHTML = ""; // ëª©ë¡ ì´ˆê¸°í™”
        };
        placeList.appendChild(listItem); // ê²°ê³¼ ì¶”ê°€
      });
    } else {
      placeList.innerHTML = "<li>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
    }
  });
}

//ì¥ì†Œ ì´ˆê¸°í™” í•¨ìˆ˜ ì¶”ê°€
function clearAddress() {
    const locationName = document.getElementById('locationName').value; // ì¥ì†Œëª… í™•ì¸
    if (!locationName) { // ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì£¼ì†Œì™€ ì¢Œí‘œ ì´ˆê¸°í™”
        document.getElementById('locationAddress').value = ''; // ì£¼ì†Œ ì´ˆê¸°í™”
        document.getElementById('locationLatitude').value = ''; // ìœ„ë„ ì´ˆê¸°í™”
        document.getElementById('locationLongitude').value = ''; // ê²½ë„ ì´ˆê¸°í™”
    }
}

function validateForm() {
  // ì…ë ¥ê°’ ê²€ì¦
  const locationName = document.getElementById('locationName').value.trim(); // ì¥ì†Œëª…
  const locationAddress = document.getElementById('locationAddress').value.trim(); // ì£¼ì†Œ
  const locationCategory = document.querySelector('input[name="locationCategory"]:checked'); // ì¹´í…Œê³ ë¦¬

  // ì¥ì†Œëª… ê²€ì¦
  if (!locationName) {
    alert("ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return false; // í¼ ì œì¶œ ì¤‘ë‹¨
  }

  // ì¹´í…Œê³ ë¦¬ ê²€ì¦
  if (!locationCategory) {
    alert("ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    return false; // í¼ ì œì¶œ ì¤‘ë‹¨
  }
  
  //ì„œë²„ì—ì„œ ì¤‘ë³µ ì¥ì†Œ í™•ì¸ (AJAX ìš”ì²­)
  const isDuplicate = checkDuplicateLocation(locationName, locationAddress);

  // ì¤‘ë³µëœ ì¥ì†Œê°€ í™•ì¸ë˜ë©´ ê²½ê³  í‘œì‹œ í›„ í¼ ì œì¶œ ì¤‘ë‹¨
  if (isDuplicate) {
    alert("ì´ë¯¸ ë“±ë¡ëœ ì¥ì†Œì…ë‹ˆë‹¤.");
    return false;
  }

  // ëª¨ë“  ê²€ì¦ í†µê³¼ ì‹œ ì œì¶œ í—ˆìš©
  return true;
}

//ì¤‘ë³µ ì¥ì†Œ í™•ì¸ í•¨ìˆ˜ (ë¹„ë™ê¸° ìš”ì²­)
function checkDuplicateLocation(locationName, locationAddress) {
  let isDuplicate = false;

  // ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­
  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/location/checkDuplicate", false); // ë™ê¸° ìš”ì²­
  xhr.setRequestHeader("Content-Type", "application/json");
  xhr.send(JSON.stringify({ locationName, locationAddress }));

  if (xhr.status === 200) {
    const response = JSON.parse(xhr.responseText);
    isDuplicate = response.isDuplicate; // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì¤‘ë³µ ì—¬ë¶€
  } else {
    alert("ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }

  return isDuplicate;
}
</script>
</body>
</html>